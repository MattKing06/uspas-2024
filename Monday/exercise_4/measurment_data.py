import numpy as np 
import scipy as sp 
from scipy import stats 
import matplotlib.pyplot as plt  
from slit_scan import BEAM_PIPE_RADIUS_MM
  
total_scan_dataset = [[-50.0, 10.0999674484257], [-49.49748743718593, 10.0999674484257], [-48.99497487437186, 10.0999674484257], [-48.49246231155779, 10.0999674484257], [-47.98994974874372, 10.099987871392692], [-47.48743718592965, 10.099987871392692], [-46.984924623115575, 10.09995437676752], [-46.482412060301506, 10.09995437676752], [-45.97989949748744, 10.100006682713333], [-45.47738693467337, 10.100006682713333], [-44.9748743718593, 10.100011500964301], [-44.472361809045225, 10.100011500964301], [-43.969849246231156, 10.100047374494544], [-43.46733668341709, 10.100047374494544], [-42.96482412060301, 10.100048495979554], [-42.462311557788944, 10.100000275504998], [-41.959798994974875, 10.100000275504998], [-41.45728643216081, 10.100013517634585], [-40.95477386934674, 10.100013517634585], [-40.45226130653266, 10.099961499438253], [-39.949748743718594, 10.099961499438253], [-39.447236180904525, 10.099999396633471], [-38.94472361809045, 10.099999396633471], [-38.44221105527638, 10.100019711235012], [-37.93969849246231, 10.100019711235012], [-37.437185929648244, 10.10003908741619], [-36.934673366834176, 10.10003908741619], [-36.4321608040201, 10.10003576849951], [-35.92964824120603, 10.10003576849951], [-35.42713567839196, 10.100037223201111], [-34.92462311557789, 10.10002365850807], [-34.42211055276382, 10.10002365850807], [-33.91959798994975, 10.099987960170802], [-33.41708542713568, 10.09997207618344], [-32.91457286432161, 10.09997207618344], [-32.41206030150754, 10.099975575871659], [-31.90954773869347, 10.099975575871659], [-31.4070351758794, 10.09998801609093], [-30.90452261306533, 10.09998801609093], [-30.402010050251256, 10.0999551809663], [-29.899497487437188, 10.0999551809663], [-29.39698492462312, 10.100008157845576], [-28.894472361809047, 10.100008157845576], [-28.391959798994975, 10.100010322152695], [-27.889447236180906, 10.100010322152695], [-27.386934673366838, 10.100008707372739], [-26.884422110552766, 10.100008707372739], [-26.381909547738694, 10.100040053507616], [-25.879396984924625, 10.100040053507616], [-25.376884422110557, 10.100037339756968], [-24.874371859296485, 10.100037339756968], [-24.371859296482413, 10.100000989732068], [-23.869346733668344, 10.100000989732068], [-23.366834170854275, 10.099991728497779], [-22.864321608040203, 10.100012574928156], [-22.36180904522613, 10.100029168345639], [-21.859296482412063, 10.099997837912932], [-21.356783919597994, 10.099997837912932], [-20.854271356783922, 10.099976972668376], [-20.35175879396985, 10.099976972668376], [-19.84924623115578, 10.0999749238636], [-19.346733668341713, 10.0999749238636], [-18.84422110552764, 10.100030811477744], [-18.34170854271357, 10.100030811477744], [-17.8391959798995, 10.09997367432788], [-17.336683417085432, 10.09997367432788], [-16.834170854271363, 10.100036088695703], [-16.331658291457288, 10.100036088695703], [-15.82914572864322, 10.10000322532412], [-15.32663316582915, 10.10000322532412], [-14.824120603015075, 10.100001932560032], [-14.321608040201006, 10.100001932560032], [-13.819095477386938, 10.10004673618055], [-13.31658291457287, 10.10004673618055], [-12.8140703517588, 10.100020259770465], [-12.311557788944725, 10.100020259770465], [-11.809045226130657, 10.099880327621822], [-11.306532663316588, 10.099880327621822], [-10.804020100502512, 10.099620198398764], [-10.301507537688444, 10.099620198398764], [-9.798994974874375, 10.098453747845243], [-9.296482412060307, 10.098453747845243], [-8.793969849246238, 10.09384384031597], [-8.291457286432163, 10.09384384031597], [-7.788944723618094, 10.078938945719951], [-7.286432160804026, 10.062833659115093], [-6.78391959798995, 10.062833659115093], [-6.2814070351758815, 9.994706271644082], [-5.778894472361813, 9.994706271644082], [-5.276381909547744, 9.836140069920878], [-4.773869346733676, 9.836140069920878], [-4.2713567839196, 9.513698077486868], [-3.7688442211055317, 9.513698077486868], [-3.266331658291463, 8.94095638986903], [-2.7638190954773876, 8.94095638986903], [-2.261306532663319, 8.052319830484109], [-1.7587939698492505, 8.052319830484109], [-1.256281407035182, 6.848003906730613], [-0.7537688442211135, 6.848003906730613], [-0.2512562814070378, 5.4219370383783145], [0.2512562814070307, 5.4219370383783145], [0.7537688442210992, 5.4219370383783145], [1.2562814070351749, 3.2520694877863154], [1.7587939698492434, 3.2520694877863154], [2.261306532663312, 2.0476767348060827], [2.7638190954773805, 2.0476767348060827], [3.266331658291449, 1.1590851792498553], [3.7688442211055246, 1.1590851792498553], [4.271356783919593, 0.5863174394631644], [4.773869346733662, 0.5863174394631644], [5.276381909547737, 0.5863174394631644], [5.778894472361806, 0.1691866385847876], [6.281407035175874, 0.1691866385847876], [6.783919597989943, 0.06349703870342464], [7.2864321608040115, 0.06349703870342464], [7.788944723618087, 0.02103575863335821], [8.291457286432156, 0.02103575863335821], [8.793969849246224, 0.006161712787596286], [9.2964824120603, 0.006161712787596286], [9.798994974874368, 0.001581781729237247], [10.301507537688437, 0.001581781729237247], [10.804020100502505, 0.0003379101265502288], [11.306532663316574, 0.0003379101265502288], [11.80904522613065, 7.834369526543033e-05], [12.311557788944718, 7.834369526543033e-05], [12.814070351758787, 8.2220748400829e-06], [13.316582914572862, 8.2220748400829e-06], [13.81909547738693, -1.7239427246296612e-05], [14.321608040201, -1.7239427246296612e-05], [14.824120603015075, 2.2651080859351076e-05], [15.326633165829136, 2.2651080859351076e-05], [15.829145728643212, 2.2651080859351076e-05], [16.331658291457273, 2.2651080859351076e-05], [16.83417085427135, 2.2651080859351076e-05], [17.336683417085425, 2.2651080859351076e-05], [17.839195979899486, 2.3383918391903843e-05], [18.34170854271356, 2.3383918391903843e-05], [18.844221105527637, 0.00010795230190705738], [19.3467336683417, 0.00010795230190705738], [19.849246231155774, 0.0002845625904279338], [20.35175879396985, 0.0002845625904279338], [20.85427135678391, 0.0010181332482770149], [21.356783919597987, 0.0010181332482770149], [21.85929648241205, 0.0033428621615694295], [22.361809045226124, 0.0033428621615694295], [22.8643216080402, 0.009482644338686388], [23.36683417085426, 0.009482644338686388], [23.869346733668337, 0.023385037640549916], [24.3718592964824, 0.023385037640549916], [24.874371859296474, 0.050252830487510024], [25.37688442211055, 0.050252830487510024], [25.87939698492461, 0.0941980097583264], [26.381909547738687, 0.0941980097583264], [26.884422110552762, 0.15408362619295643], [27.386934673366824, 0.15408362619295643], [27.8894472361809, 0.21991548276330844], [28.391959798994975, 0.21991548276330844], [28.894472361809036, 0.27357315169252083], [29.396984924623112, 0.27357315169252083], [29.899497487437174, 0.27357315169252083], [30.40201005025125, 0.29399245724670836], [30.904522613065325, 0.29399245724670836], [31.407035175879386, 0.25995324240866013], [31.909547738693462, 0.25995324240866013], [32.41206030150752, 0.20048592263819534], [32.9145728643216, 0.20048592263819534], [33.417085427135675, 0.13490270584901692], [33.919597989949736, 0.10513242398025673], [34.42211055276381, 0.10513242398025673], [34.92462311557789, 0.05761317657594247], [35.42713567839195, 0.05761317657594247], [35.929648241206024, 0.027553814876928373], [36.4321608040201, 0.027553814876928373], [36.93467336683416, 0.011500073247577179], [37.43718592964824, 0.011500073247577179], [37.9396984924623, 0.004170296248139387], [38.442211055276374, 0.004170296248139387], [38.94472361809045, 0.0013442195432584343], [39.44723618090451, 0.0013442195432584343], [39.94974874371859, 0.0003216032462372288], [40.45226130653265, 0.0003216032462372288], [40.954773869346724, 0.0001295362652307486], [41.4572864321608, 0.0001295362652307486], [41.95979899497486, 3.4474432709951975e-06], [42.46231155778894, 3.4474432709951975e-06], [42.96482412060301, 5.162616482558671e-05], [43.467336683417074, 5.162616482558671e-05], [43.96984924623115, 2.461214451659276e-05], [44.472361809045225, 2.461214451659276e-05], [44.974874371859286, 3.72013141795112e-05], [45.47738693467336, 3.72013141795112e-05], [45.97989949748742, 4.9104426837400355e-05], [46.4824120603015, 4.9104426837400355e-05], [46.984924623115575, -4.0769249399781685e-05], [47.487437185929636, -4.0769249399781685e-05], [47.98994974874371, 1.965773534832789e-05], [48.49246231155777, 1.965773534832789e-05], [48.99497487437185, 4.8769849523473886e-05], [49.497487437185924, 4.8769849523473886e-05], [50.0, -1.180309278064925e-05]]
total_positions = [total_scan_dataset[i][0] for i in range(0, len(total_scan_dataset))]
total_charges = [total_scan_dataset[i][1] for i in range(0, len(total_scan_dataset))]
slit_active_data = [[10.0, 0.0011362656104295947], [10.677966101694915, 0.0011362656104295947], [11.35593220338983, 0.00016187145119463144], [12.033898305084746, 0.00016187145119463144], [12.711864406779661, 4.4949323957633234e-05], [13.389830508474576, 4.4949323957633234e-05], [14.067796610169491, 3.0414311685471182e-05], [14.745762711864407, 3.0414311685471182e-05], [15.423728813559322, 3.8629464268140756e-05], [16.101694915254235, 3.8629464268140756e-05], [16.779661016949152, 3.203952003960787e-05], [17.45762711864407, 3.203952003960787e-05], [18.135593220338983, -7.466847769862841e-07], [18.813559322033896, -7.466847769862841e-07], [19.491525423728813, 0.00016078701540986573], [20.16949152542373, 0.00016078701540986573], [20.847457627118644, 0.001008888162909061], [21.525423728813557, 0.001008888162909061], [22.203389830508474, 0.0048323016845338435], [22.88135593220339, 0.0048323016845338435], [23.559322033898304, 0.017933013609233838], [24.237288135593218, 0.017933013609233838], [24.915254237288135, 0.0517335635360205], [25.593220338983052, 0.0517335635360205], [26.271186440677965, 0.1159931279992902], [26.94915254237288, 0.1159931279992902], [27.627118644067796, 0.20307867033071678], [28.305084745762713, 0.20307867033071678], [28.983050847457626, 0.2771059944382193], [29.66101694915254, 0.2771059944382193], [30.338983050847457, 0.2948991863135779], [31.016949152542374, 0.2948991863135779], [31.694915254237287, 0.2948991863135779], [32.3728813559322, 0.20309530156765587], [33.050847457627114, 0.20309530156765587], [33.728813559322035, 0.11605973823273043], [34.40677966101695, 0.11605973823273043], [35.08474576271186, 0.05167953690951445], [35.76271186440678, 0.05167953690951445], [36.440677966101696, 0.01796431393228257], [37.11864406779661, 0.01796431393228257], [37.79661016949152, 0.004918424181661224], [38.474576271186436, 0.004918424181661224], [39.152542372881356, 0.0010736100698654253], [39.83050847457627, 0.0010736100698654253], [40.50847457627118, 0.00014238817694389003], [41.186440677966104, 0.00014238817694389003], [41.86440677966102, 9.833055576834835e-06], [42.54237288135593, 9.833055576834835e-06], [43.220338983050844, 5.158976768182301e-05], [43.89830508474576, 5.158976768182301e-05], [44.57627118644068, 3.9263806048175465e-05], [45.25423728813559, 3.9263806048175465e-05], [45.932203389830505, 3.6584174955024176e-05], [46.610169491525426, 3.6584174955024176e-05], [47.28813559322034, -3.0481465123570706e-05], [47.96610169491525, -3.0481465123570706e-05], [48.644067796610166, -8.375434996701537e-06], [49.32203389830508, -8.375434996701537e-06], [50.0, -3.967450426597255e-05]]
positions = [slit_active_data[i][0] for i in range(0, len(slit_active_data))]
charges = [slit_active_data[i][1] for i in range(0, len(slit_active_data))]
mu, std = stats.norm.fit(slit_active_data)
print(f'Transverse RMS beam size: {mu} mm')

#####
# Beam is intercepted by entire slit when charge is lowest
#####
min_charge_index = total_charges.index(min(total_charges))
intercept_position = total_positions[min_charge_index]
print(f'Beam is intercepted at: {intercept_position} mm')
print(f'Beam position relative to slit: {BEAM_PIPE_RADIUS_MM - intercept_position} mm')

charges = [measurment[1] for measurment in slit_active_data]
slit_end_position = slit_active_data[-1][0]
slit_start_position = slit_active_data[0][0]
total_slit_distance = slit_end_position - slit_start_position
integrated_charge = float(np.sum(charges))
max_charge = max(total_scan_dataset[:][0])
slit_diff = slit_active_data[1][0] -slit_active_data[0][0]

#########
# the fraction of the beam (integrated charge/max_charge)
# is the same as the fraction of the slit position (delta)
# of the total slit distance
#########
slit_width = (integrated_charge/max_charge)*slit_diff
print(f'Slit width: {slit_width} mm')

